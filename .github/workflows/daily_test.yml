name: Litemallæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•å¹¶å‘é€é‚®ä»¶

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # åŒ—äº¬æ—¶é—´ 14:00

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          pip install pytest requests pytest-html

      - name: 4. è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•å¹¶ç”Ÿæˆç»“æœæ•°æ®
        continue-on-error: true
        run: |
          python -m pytest tests/ --html=report.html --self-contained-html --junitxml=result.xml

      - name: 5. æ‰§è¡Œ Python è„šæœ¬å‘é€â€œå¯è§†åŒ–â€é‚®ä»¶
        env:
          # æ³¨æ„ï¼šè¿™é‡Œçš„ç¼©è¿›å·²å¯¹é½ env å…³é”®å­—
          MAIL_USER: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASS: ${{ secrets.MAIL_PASSWORD }}
          RECEIVER: '1143568940@qq.com'
        run: |
          python - <<EOF
          import smtplib, os, sys, requests
          import xml.etree.ElementTree as ET
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from email.mime.application import MIMEApplication

          def get_wise_rate():
              """è·å–å®æ—¶æ±‡ç‡"""
              try:
                  url = "https://wise.com/web-api/v1/rates"
                  params = {"source": "MYR", "target": "CNY"}
                  headers = {"User-Agent": "Mozilla/5.0"}
                  response = requests.get(url, params=params, headers=headers, timeout=10)
                  return response.json()[0]['rate']
              except Exception as e:
                  print(f"è·å–æ±‡ç‡å¤±è´¥: {e}")
                  return "æœªçŸ¥"

          def get_test_stats():
              try:
                  if not os.path.exists('result.xml'):
                      return None
                  tree = ET.parse('result.xml')
                  root = tree.getroot()
                  # å…¼å®¹ä¸åŒçš„ junitxml æ ¼å¼
                  testsuite = root if root.tag == 'testsuite' else root[0]
                  stats = {
                      "total": testsuite.get('tests', '0'),
                      "failures": testsuite.get('failures', '0'),
                      "errors": testsuite.get('errors', '0'),
                      "skipped": testsuite.get('skipped', '0'),
                      "time": testsuite.get('time', '0')
                  }
                  stats["passed"] = int(stats["total"]) - int(stats["failures"]) - int(stats["errors"]) - int(stats["skipped"])
                  return stats
              except Exception as e:
                  print(f"è§£æ XML å¤±è´¥: {e}")
                  return None

          def send_mail():
              sender = os.environ.get('MAIL_USER')
              password = os.environ.get('MAIL_PASS')
              receiver = os.environ.get('RECEIVER')
              
              # è·å–æ±‡ç‡å’Œæµ‹è¯•ç»Ÿè®¡
              exchange_rate = get_wise_rate()
              stats = get_test_stats()
              
              msg = MIMEMultipart()
              msg['Subject'] = f"ğŸ“Š æµ‹è¯•æŠ¥å‘Š | ä»Šæ—¥æ±‡ç‡: {exchange_rate}"
              msg['From'] = f"QA-Bot <{sender}>"
              msg['To'] = receiver

              if stats:
                  color = "#28a745" if int(stats['failures']) == 0 else "#dc3545"
                  html_body = f"""
                  <html>
                    <body>
                      <h2 style="color: {color};">æµ‹è¯•æ‰§è¡Œå®Œæ¯•</h2>
                      <h3 style="color: #007bff;">ğŸ’± æ±‡ç‡ç›‘æ§</h3>
                      <p><b>å½“å‰æ±‡ç‡ï¼š1 MYR = <span style="font-size: 18px; color: #e83e8c;">{exchange_rate}</span> CNY</b></p>
                      <h3 style="color: #007bff;">ğŸ§ª æµ‹è¯•ç»Ÿè®¡</h3>
                      <table border="1" style="border-collapse: collapse; width: 300px; text-align: center;">
                        <tr style="background-color: #f2f2f2;"><th>é¡¹ç›®</th><th>æ•°é‡</th></tr>
                        <tr><td>æ€»ç”¨ä¾‹æ•°</td><td><b>{stats['total']}</b></td></tr>
                        <tr style="color: green;"><td>é€šè¿‡æ•°</td><td><b>{stats['passed']}</b></td></tr>
                        <tr style="color: red;"><td>å¤±è´¥æ•°</td><td><b>{stats['failures']}</b></td></tr>
                        <tr><td>è€—æ—¶</td><td>{stats['time']}s</td></tr>
                      </table>
                      <p>è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹é‚®ä»¶é™„ä»¶æŠ¥å‘Šã€‚</p>
                    </body>
                  </html>
                  """
              else:
                  html_body = f"æµ‹è¯•æ‰§è¡Œå®Œæ¯•ã€‚å½“å‰æ±‡ç‡: {exchange_rate}ã€‚ä½†è§£æç»“æœæ•°æ®å¤±è´¥ã€‚"

              msg.attach(MIMEText(html_body, 'html'))

              if os.path.exists("report.html"):
                  with open("report.html", "rb") as f:
                      part = MIMEApplication(f.read(), Name="report.html")
                      part['Content-Disposition'] = 'attachment; filename="report.html"'
                      msg.attach(part)

              try:
                  server = smtplib.SMTP_SSL("smtp.qq.com", 465)
                  server.login(sender, password)
                  server.sendmail(sender, [receiver], msg.as_string())
                  server.quit()
                  print("âœ… æ±‡ç‡+æµ‹è¯•å¯è§†åŒ–é‚®ä»¶å‘é€æˆåŠŸï¼")
              except Exception as e:
                  print(f"âŒ å‘é€å¤±è´¥: {e}")
                  sys.exit(1)

          if __name__ == "__main__":
              send_mail()
          EOF