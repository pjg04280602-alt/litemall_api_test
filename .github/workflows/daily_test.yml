name: Litemall接口自动化测试并发送邮件

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. 安装依赖
        run: |
          pip install pytest requests pytest-html

      - name: 4. 运行测试
        continue-on-error: true
        run: |
          python -m pytest tests/ --html=report.html --self-contained-html

      - name: 5. 终极兼容版邮件发送
        env:
            MAIL_USER: ${{ secrets.MAIL_USERNAME }}
            MAIL_PASS: ${{ secrets.MAIL_PASSWORD }}
            RECEIVER: '1143568940@qq.com'
        run: |
            python - <<EOF
            import smtplib, os, sys
            from email.mime.text import MIMEText
            from email.mime.multipart import MIMEMultipart
            from email.mime.application import MIMEApplication
            
            try:
                # 尝试使用 exmail 备用网关，它对海外 IP 更友好
                smtp_server = "smtp.exmail.qq.com"
                smtp_port = 465
                sender = os.environ['MAIL_USER']
                password = os.environ['MAIL_PASS']
                receiver = os.environ['RECEIVER']
            
                msg = MIMEMultipart()
                msg['Subject'] = "Litemall 接口测试报告-自动发送"
                msg['From'] = sender
                msg['To'] = receiver
                msg.attach(MIMEText("测试执行完毕，附件为最新测试报告。", 'plain'))
            
                if os.path.exists("report.html"):
                    with open("report.html", "rb") as f:
                        part = MIMEApplication(f.read(), Name="report.html")
                        part['Content-Disposition'] = 'attachment; filename="report.html"'
                        msg.attach(part)
            
                print(f"[*] 准备通过 {smtp_server} 发送...")
                # 强制使用 SSL 环境
                server = smtplib.SMTP_SSL(smtp_server, smtp_port, timeout=30)
                server.set_debuglevel(1) # 开启底层日志，你会看到具体的认证过程
            
                print("[*] 正在验证身份...")
                server.login(sender, password)
            
                print("[*] 正在投递邮件...")
                server.sendmail(sender, [receiver], msg.as_string())
                server.quit()
                print("✅ 发送成功！请检查收件箱（包括垃圾箱）。")
            except Exception as e:
                print(f"\n❌ 错误详情: {str(e)}")
                sys.exit(1)
            EOF