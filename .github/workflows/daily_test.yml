name: Litemallæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•å¹¶å‘é€é‚®ä»¶

on:
  push:
    branches: [ main ]
  workflow_dispatch: # ä¿ç•™æ‰‹åŠ¨è§¦å‘æŒ‰é’®
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 13:00 (UTC 05:00) è‡ªåŠ¨æ‰§è¡Œ
    - cron: '0 5 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          pip install pytest requests pytest-html

      - name: 4. è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•å¹¶ç”Ÿæˆç»“æœæ•°æ®
        continue-on-error: true
        run: |
          # å¢åŠ  --junitxml å‚æ•°ï¼Œç”¨äº Python è§£æç»“æœ
          python -m pytest tests/ --html=report.html --self-contained-html --junitxml=result.xml

      - name: 5. æ‰§è¡Œ Python è„šæœ¬å‘é€â€œå¯è§†åŒ–â€é‚®ä»¶
        env:
          MAIL_USER: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASS: ${{ secrets.MAIL_PASSWORD }}
          RECEIVER: '1143568940@qq.com'
        run: |
          python - <<EOF
          import smtplib, os, sys
          import xml.etree.ElementTree as ET
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from email.mime.application import MIMEApplication
          
          def get_test_stats():
              """ä» result.xml è§£ææµ‹è¯•ç»Ÿè®¡æ•°æ®"""
              try:
                  tree = ET.parse('result.xml')
                  root = tree.getroot()
                  testsuite = root[0] if len(root) > 0 else root
                  stats = {
                      "total": testsuite.get('tests', 0),
                      "failures": testsuite.get('failures', 0),
                      "errors": testsuite.get('errors', 0),
                      "skipped": testsuite.get('skipped', 0),
                      "time": testsuite.get('time', 0)
                  }
                  # è®¡ç®—é€šè¿‡æ•°
                  stats["passed"] = int(stats["total"]) - int(stats["failures"]) - int(stats["errors"]) - int(stats["skipped"])
                  return stats
              except:
                  return None
          
          def send_mail():
              sender = os.environ.get('MAIL_USER')
              password = os.environ.get('MAIL_PASS')
              receiver = os.environ.get('RECEIVER')
          
              stats = get_test_stats()
          
              msg = MIMEMultipart()
              msg['Subject'] = "ğŸ“Š Litemall æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š"
              msg['From'] = f"QA-Bot <{sender}>"
              msg['To'] = receiver
          
              # æ„å»ºæ¼‚äº®çš„æ­£æ–‡ HTML
              if stats:
                  color = "#28a745" if int(stats['failures']) == 0 else "#dc3545"
                  html_body = f"""
                  <html>
                    <body>
                      <h2 style="color: {color};">æµ‹è¯•æ‰§è¡Œå®Œæ¯•</h2>
                      <table border="1" style="border-collapse: collapse; width: 300px; text-align: center;">
                        <tr style="background-color: #f2f2f2;"><th>é¡¹ç›®</th><th>æ•°é‡</th></tr>
                        <tr><td>æ€»ç”¨ä¾‹æ•°</td><td><b>{stats['total']}</b></td></tr>
                        <tr style="color: green;"><td>é€šè¿‡æ•°</td><td><b>{stats['passed']}</b></td></tr>
                        <tr style="color: red;"><td>å¤±è´¥æ•°</td><td><b>{stats['failures']}</b></td></tr>
                        <tr style="color: orange;"><td>æŠ¥é”™æ•°</td><td><b>{stats['errors']}</b></td></tr>
                        <tr><td>è€—æ—¶</td><td>{stats['time']}s</td></tr>
                      </table>
                      <p>è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹é‚®ä»¶é™„ä»¶æŠ¥å‘Šã€‚</p>
                    </body>
                  </html>
                  """
              else:
                  html_body = "æµ‹è¯•æ‰§è¡Œå®Œæ¯•ï¼Œä½†è§£æç»“æœå¤±è´¥ï¼Œè¯·æŸ¥çœ‹é™„ä»¶æŠ¥å‘Šã€‚"
          
              msg.attach(MIMEText(html_body, 'html'))
          
              # æ·»åŠ é™„ä»¶
              if os.path.exists("report.html"):
                  with open("report.html", "rb") as f:
                      part = MIMEApplication(f.read(), Name="report.html")
                      part['Content-Disposition'] = 'attachment; filename="report.html"'
                      msg.attach(part)
          
              try:
                  server = smtplib.SMTP_SSL("smtp.qq.com", 465)
                  server.login(sender, password)
                  server.sendmail(sender, [receiver], msg.as_string())
                  server.quit()
                  print("âœ… å¯è§†åŒ–é‚®ä»¶å‘é€æˆåŠŸï¼")
              except Exception as e:
                  print(f"âŒ å‘é€å¤±è´¥: {e}")
                  sys.exit(1)
          
          if __name__ == "__main__":
              send_mail()
          EOF