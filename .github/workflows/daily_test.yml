name: Litemall接口自动化测试并发送邮件

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. 安装依赖
        run: |
          pip install pytest requests pytest-html

      - name: 4. 运行测试
        continue-on-error: true
        run: |
          python -m pytest tests/ --html=report.html --self-contained-html

      - name: 5. 使用 Python 发送邮件
        env:
            MAIL_USER: ${{ secrets.MAIL_USERNAME }}
            MAIL_PASS: ${{ secrets.MAIL_PASSWORD }}
            RECEIVER: '1143568940@qq.com'
        run: |
            python - <<EOF
            import smtplib
            import os
            from email.mime.text import MIMEText
            from email.mime.multipart import MIMEMultipart
            from email.mime.application import MIMEApplication
            
            # 配置参数
            smtp_server = "smtp.qq.com"
            smtp_port = 465
            sender = os.environ['MAIL_USER']
            password = os.environ['MAIL_PASS']
            receiver = os.environ['RECEIVER']
            
            # 创建邮件对象
            msg = MIMEMultipart()
            msg['Subject'] = "Litemall 自动化测试报告"
            msg['From'] = f"GitHub-Bot <{sender}>"
            msg['To'] = receiver
            
            # 邮件正文
            body = "自动化测试已执行完毕，测试报告见附件。"
            msg.attach(MIMEText(body, 'plain'))
            
            # 添加附件
            try:
                with open("report.html", "rb") as f:
                    part = MIMEApplication(f.read(), Name="report.html")
                    part['Content-Disposition'] = 'attachment; filename="report.html"'
                    msg.attach(part)
            except Exception as e:
                print(f"附件读取失败: {e}")
            
            # 发送邮件
            try:
                with smtplib.SMTP_SSL(smtp_server, smtp_port) as server:
                    server.login(sender, password)
                    server.sendmail(sender, [receiver], msg.as_string())
                print("邮件发送成功！")
            except Exception as e:
                print(f"邮件发送失败: {e}")
                exit(1)
            EOF