name: Litemallæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•å¹¶å‘é€é‚®ä»¶

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # åŒ—äº¬æ—¶é—´ 14:00

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          pip install pytest requests pytest-html

      - name: 4. è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
        continue-on-error: true
        run: |
          python -m pytest tests/ --html=report.html --self-contained-html --junitxml=result.xml

      - name: 5. æ‰§è¡Œ Python è„šæœ¬å‘é€é‚®ä»¶
        if: always()
        env:
          MAIL_USER: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASS: ${{ secrets.MAIL_PASSWORD }}
          RECEIVER: '1143568940@qq.com'
        run: |
          python - <<EOF
          import smtplib, os, sys, requests
          import xml.etree.ElementTree as ET
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from email.mime.application import MIMEApplication

          def get_rate():
              """åŒæ¥å£å¤‡ä»½è·å–æ±‡ç‡"""
              # å°è¯• Wise æ¥å£
              try:
                  url = "https://wise.com/web-api/v1/rates"
                  headers = {
                      "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
                      "Referer": "https://wise.com/zh-cn/currency-converter/myr-to-cny-rate"
                  }
                  r = requests.get(url, params={"source":"MYR", "target":"CNY"}, headers=headers, timeout=10)
                  if r.status_code == 200:
                      return r.json()[0]['rate']
              except:
                  pass
              
              # å°è¯•å…¬å¼€å¤‡ç”¨æ¥å£
              try:
                  r = requests.get("https://api.exchangerate-api.com/v4/latest/MYR", timeout=10)
                  return r.json()['rates']['CNY']
              except:
                  return "è·å–å¤±è´¥"

          def get_test_stats():
              try:
                  if not os.path.exists('result.xml'): return None
                  tree = ET.parse('result.xml')
                  root = tree.getroot()
                  ts = root if root.tag == 'testsuite' else root[0]
                  total = int(ts.get('tests', 0))
                  fail = int(ts.get('failures', 0))
                  err = int(ts.get('errors', 0))
                  skip = int(ts.get('skipped', 0))
                  return {
                      "total": total, "failures": fail, "time": ts.get('time', 0),
                      "passed": total - fail - err - skip
                  }
              except: return None

          def send():
              rate = get_rate()
              stats = get_test_stats()
              sender = os.environ.get('MAIL_USER')
              msg = MIMEMultipart()
              msg['Subject'] = f"ğŸ“Š æµ‹è¯•æŠ¥å‘Š | ä»Šæ—¥æ±‡ç‡: {rate}"
              msg['From'] = f"QA-Bot <{sender}>"
              msg['To'] = os.environ.get('RECEIVER')
              
              color = "#28a745" if stats and int(stats['failures']) == 0 else "#dc3545"
              html = f"""
              <html><body>
                <h2 style="color: {color};">æµ‹è¯•æ‰§è¡Œå®Œæ¯•</h2>
                <h3 style="color: #007bff;">ğŸ’± æ±‡ç‡ç›‘æ§ (MYR -> CNY)</h3>
                <p style="font-size: 20px;"><b>1 MYR = <span style="color: #e83e8c;">{rate}</span> CNY</b></p>
              """
              if stats:
                  html += f"""
                  <h3 style="color: #007bff;">ğŸ§ª æµ‹è¯•ç»Ÿè®¡</h3>
                  <table border="1" style="border-collapse: collapse; text-align: center;">
                    <tr style="background-color: #f2f2f2;"><th>é¡¹ç›®</th><th>æ•°é‡</th></tr>
                    <tr><td>æ€»ç”¨ä¾‹</td><td>{stats['total']}</td></tr>
                    <tr style="color: green;"><td>é€šè¿‡</td><td>{stats['passed']}</td></tr>
                    <tr style="color: red;"><td>å¤±è´¥</td><td>{stats['failures']}</td></tr>
                  </table>
                  """
              html += "</body></html>"
              msg.attach(MIMEText(html, 'html'))
              
              if os.path.exists("report.html"):
                  with open("report.html", "rb") as f:
                      part = MIMEApplication(f.read(), Name="report.html")
                      part['Content-Disposition'] = 'attachment; filename="report.html"'
                      msg.attach(part)
              
              s = smtplib.SMTP_SSL("smtp.qq.com", 465)
              s.login(sender, os.environ.get('MAIL_PASS'))
              s.sendmail(sender, [msg['To']], msg.as_string())
              s.quit()

          if __name__ == "__main__": send()
          EOF