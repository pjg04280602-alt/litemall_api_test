name: Litemall接口自动化测试并发送邮件

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. 安装依赖
        run: |
          pip install pytest requests pytest-html

      - name: 4. 运行测试
        continue-on-error: true
        run: |
          python -m pytest tests/ --html=report.html --self-contained-html

      - name: 5. 调试版邮件发送
        env:
            MAIL_USER: ${{ secrets.MAIL_USERNAME }}
            MAIL_PASS: ${{ secrets.MAIL_PASSWORD }}
            RECEIVER: '1143568940@qq.com'
        run: |
            python - <<EOF
            import smtplib, os
            from email.mime.text import MIMEText
            from email.mime.multipart import MIMEMultipart
            from email.mime.application import MIMEApplication
            
            try:
                smtp_server = "smtp.qq.com"
                smtp_port = 465
                sender = os.environ['MAIL_USER']
                password = os.environ['MAIL_PASS']
                receiver = os.environ['RECEIVER']
            
                msg = MIMEMultipart()
                msg['Subject'] = "Litemall测试报告-调试版"
                msg['From'] = sender
                msg['To'] = receiver
                msg.attach(MIMEText("测试正文", 'plain'))
            
                if os.path.exists("report.html"):
                    with open("report.html", "rb") as f:
                        part = MIMEApplication(f.read(), Name="report.html")
                        part['Content-Disposition'] = 'attachment; filename="report.html"'
                        msg.attach(part)
            
                # 调试模式启动
                print(f"正在尝试连接 {smtp_server}...")
                server = smtplib.SMTP_SSL(smtp_server, smtp_port)
                print("连接成功，正在登录...")
                server.login(sender, password)
                print("登录成功，正在发信...")
                server.sendmail(sender, [receiver], msg.as_string())
                server.quit()
                print("✨ 邮件已送达！")
            except Exception as e:
                print("\n❌ 错误详情:")
                print(str(e))
                exit(1)
            EOF